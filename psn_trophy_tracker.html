<!--
Updated PSN Trophy Tracker for LauxxyTG
Features:
- Manual 'Currently Playing' highlight (edit CURRENTLY_PLAYING_GAME variable)
- Search bar to filter games
- Animated 100% completion badges
- Mobile-friendly, dark theme
- 'Retrieve latest trophy updates' button
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lauxxy ‚Äî PSN Trophy Tracker</title>
  <meta name="description" content="Public PSN trophy tracker for Lauxxy (PSNProfiles: LauxxyTG)." />

  <!-- Tailwind from CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); transition: transform 0.2s; }
    .card:hover { transform: scale(1.02); }
    .accent { color: #ef4444; }
    .currently-playing { border: 2px solid #ef4444; position: relative; }
    .currently-playing-badge {
      position: absolute; top: 0.25rem; right: 0.25rem;
      background: #ef4444; color: white; font-size: 0.65rem; padding: 0.1rem 0.3rem; border-radius: 0.25rem;
    }
    .badge-100 {
      background: gold; color: #111; padding: 0.15rem 0.3rem; border-radius: 0.25rem;
      animation: pulse 1.5s infinite alternate;
      font-weight: bold; font-size: 0.7rem;
      margin-left: 0.5rem;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px gold; transform: scale(1); }
      100% { box-shadow: 0 0 15px gold; transform: scale(1.05); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-extrabold">Lauxxy's Trophy Tracker <span class="text-sm">üê∫</span></h1>
      <p class="text-gray-400 mt-1">Tracking PSNProfiles user <span class="accent">LauxxyTG</span>. Public & read-only.</p>
    </header>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <div class="flex items-center gap-3">
        <button id="refreshBtn" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-500 focus:outline-none">Retrieve latest trophy updates.</button>
      </div>
      <input id="searchInput" type="text" placeholder="Search games..." class="px-3 py-2 rounded-md bg-gray-800 text-gray-100 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500" />
      <div class="text-sm text-gray-400">Last update: <span id="lastUpdate">‚Äî</span></div>
    </div>

    <main>
      <div id="status" class="text-sm text-gray-400 mb-4">Click "Retrieve latest trophy updates." to fetch the latest trophies from psnprofiles.com.</div>

      <div id="gamesGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

      <div id="fallbackNote" class="mt-6 text-sm text-gray-500"></div>
    </main>

    <footer class="mt-8 text-center text-xs text-gray-600">Data sources: psnprofiles.com (public pages). Built for Steek.</footer>
  </div>

<script>
// Configuration
const PSNPROFILE_USER = 'LauxxyTG';
const PROFILE_URL = `https://psnprofiles.com/${PSNPROFILE_USER}`;
const PROXY_RAW = 'https://api.allorigins.win/raw?url=';
const CACHE_KEY = 'psn_trophies_cache_lauxxytg_v2';
const CACHE_TIME_KEY = 'psn_trophies_cache_time_lauxxytg_v2';

// Set your currently playing game manually here:
const CURRENTLY_PLAYING_GAME = 'Elden Ring'; // Change this to highlight a different game

// Elements
const refreshBtn = document.getElementById('refreshBtn');
const gamesGrid = document.getElementById('gamesGrid');
const statusEl = document.getElementById('status');
const lastUpdateEl = document.getElementById('lastUpdate');
const searchInput = document.getElementById('searchInput');
const fallbackNote = document.getElementById('fallbackNote');

refreshBtn.addEventListener('click', () => fetchAndRender(true));
searchInput.addEventListener('input', () => filterGames());

document.addEventListener('DOMContentLoaded', () => loadCachedAndRender());

async function fetchAndRender() {
  try {
    setStatus('Fetching latest data‚Ä¶');
    const url = PROXY_RAW + encodeURIComponent(PROFILE_URL);
    const res = await fetch(url);
    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
    const html = await res.text();

    const parsed = parseProfileHTML(html);
    if (!parsed || parsed.length === 0) {
      setStatus('Could not find games. Showing cache (if any).');
      fallbackNote.textContent = 'If parsing fails, update parser selectors in code.';
      return loadCachedAndRender();
    }

    localStorage.setItem(CACHE_KEY, JSON.stringify(parsed));
    localStorage.setItem(CACHE_TIME_KEY, new Date().toISOString());

    renderGames(parsed);
    setLastUpdate(new Date());
    setStatus('Successfully updated.');
  } catch (err) {
    console.error(err);
    setStatus('Update failed: ' + err.message);
    fallbackNote.textContent = 'Fetch failed ‚Äî you can still load cached data.';
    loadCachedAndRender();
  }
}

function loadCachedAndRender() {
  const raw = localStorage.getItem(CACHE_KEY);
  const t = localStorage.getItem(CACHE_TIME_KEY);
  if (!raw) {
    setStatus('No cached data. Click "Retrieve latest trophy updates."');
    lastUpdateEl.textContent = '‚Äî';
    return;
  }
  try {
    const parsed = JSON.parse(raw);
    renderGames(parsed);
    setLastUpdate(t ? new Date(t) : null);
    setStatus('Loaded cached data. Click "Retrieve latest trophy updates." to refresh.');
  } catch (err) {
    console.error('Cache parse error', err);
    setStatus('Cached data corrupted. Fetch fresh data.');
  }
}

function setStatus(text) { statusEl.textContent = text; }
function setLastUpdate(date) { lastUpdateEl.textContent = date ? new Date(date).toLocaleString() : '‚Äî'; }

function renderGames(games) {
  gamesGrid.innerHTML = '';
  const query = searchInput.value.toLowerCase();
  games.forEach(g => {
    if (query && !g.title.toLowerCase().includes(query)) return;

    const card = document.createElement('article');
    card.className = 'card p-4 rounded-lg shadow-sm flex gap-3 items-center relative';
    if (g.title === CURRENTLY_PLAYING_GAME) card.classList.add('currently-playing');

    const img = document.createElement('img');
    img.src = g.icon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96"></svg>';
    img.alt = g.title;
    img.className = 'w-20 h-20 rounded-md object-cover flex-shrink-0';

    const body = document.createElement('div');
    body.className = 'flex-1 min-w-0';

    const title = document.createElement('a');
    title.href = g.link || '#';
    title.target = '_blank';
    title.rel = 'noopener noreferrer';
    title.className = 'font-semibold truncate block';
    title.textContent = g.title;

    if (g.title === CURRENTLY_PLAYING_GAME) {
      const badge = document.createElement('div');
      badge.className = 'currently-playing-badge';
      badge.textContent = 'Currently Playing üéÆ';
      card.appendChild(badge);
    }

    const pctRow = document.createElement('div');
    pctRow.className = 'mt-1 text-sm text-gray-300 flex items-center gap-2';

    const pctBarWrap = document.createElement('div');
    pctBarWrap.className = 'w-full bg-gray-800 rounded-full h-3 overflow-hidden';

    const pctBar = document.createElement('div');
    pctBar.className = 'h-3 rounded-full bg-gradient-to-r from-red-500 via-red-400 to-yellow-400';
    pctBar.style.width = (g.percent || 0) + '%';
    pctBar.setAttribute('aria-valuenow', g.percent || 0);

    pctBarWrap.appendChild(pctBar);
    const pctLabel = document.createElement('div');
    pctLabel.textContent = (g.percent !== undefined) ? (g.percent + '%') : '‚Äî';
    pctLabel.className = 'text-xs w-14 text-right';

    pctRow.appendChild(pctBarWrap);
    pctRow.appendChild(pctLabel);

    const trophyRow = document.createElement('div');
    trophyRow.className = 'mt-2 text-xs text-gray-400 flex gap-3 items-center';
    trophyRow.innerHTML = `
      <div title="Platinum">üèÜ ${g.platinum ?? 0}</div>
      <div title="Gold">ü•á ${g.gold ?? 0}</div>
      <div title="Silver">ü•à ${g.silver ?? 0}</div>
      <div title="Bronze">üü§ ${g.bronze ?? 0}</div>
    `;

    if (g.percent === 100) {
      const badge100 = document.createElement('span');
      badge100.className = 'badge-100';
      badge100.textContent = 'üèÜ 100% Completed!';
      trophyRow.appendChild(badge100);
    }

    body.appendChild(title);
    body.appendChild(pctRow);
    body.appendChild(trophyRow);

    card.appendChild(img);
    card.appendChild(body);

    gamesGrid.appendChild(card);
  });
}

function filterGames() {
  const raw = localStorage.getItem(CACHE_KEY);
  if (!raw) return;
  const parsed = JSON.parse(raw);
  renderGames(parsed);
}

function parseProfileHTML(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const results = [];
  const anchors = Array.from(doc.querySelectorAll('a[href*="/game/"]'));
  const seen = new Set();

  for (const a of anchors) {
    const href = a.getAttribute('href');
    if (!href || seen.has(href)) continue;
    seen.add(href);
    let title = a.textContent.trim() || a.getAttribute('title') || '';
    title = title.replace(/\s+/g,' ').trim();
    const link = href.startsWith('http') ? href : new URL(href,'https://psnprofiles.com').href;
    const img = a.querySelector('img') || a.querySelector('picture img');
    const icon = img ? img.src || img.getAttribute('data-src') : null;
    let percent = null;
    const parent = a.parentElement;
    if (parent){const m = parent.innerText.match(/(\d{1,3})%/); if(m) percent=parseInt(m[1],10);}
    results.push({title, link, icon, percent});
  }
  return results;
}
</script>
</body>
</html>
